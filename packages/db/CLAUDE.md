# Database Package

## 概述

Drizzle ORM with PostgreSQL, auto-generated auth tables via Better-Auth adapter.

---

## 结构

```
src/
├── index.ts              # DB client export
├── schema/               # Table definitions
│   └── *.ts              # Schema files
└── migrations/           # Migration tracking
    └── meta/             # Migration metadata
```

---

## 快速查找

| Task          | Location                                       |
| ------------- | ---------------------------------------------- |
| DB client     | index.ts                                       |
| Table schemas | schema/\*.ts                                   |
| Auth tables   | Auto-generated by Better-Auth                  |
| Relations     | Define in schema files using Drizzle relations |

---

## 规范

### Schema 定义

使用 `pgTable` 定义表，`uuidv7()` 作为主键：

```typescript
import { pgTable, text, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: text("id")
    .primaryKey()
    .default(sql`uuidv7()`),
  name: text("name").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at")
    .defaultNow()
    .$onUpdate(() => new Date())
    .notNull(),
});
```

### Migrations

```bash
bun run db:push         # Apply schema, update types
bun run db:studio       # GUI at http://localhost:5555
bun run db:generate     # Generate types from SQL
bun run db:migrate      # Create migration file
```

### Auth Tables

所有 auth 相关表由 Better-Auth 自动生成 - **不要手动修改** `schema/auth.ts`。

---

## 反模式

- **不要修改自动生成的 auth 表** - Better-Auth 管理 schema/auth.ts
- **不要提交生成的文件** - 提交 schema 更改，不提交生成的 SQL
- **不要跳过关系定义** - 始终定义 relations 以获得类型安全查询
- **不要使用原始 SQL** - 使用 Drizzle query builder

---

## 独特风格

- **Push-based migrations**: `db:push` 更新 schema 和类型，无需手动 SQL
- **Auth integration**: Better-Auth adapter 自动在 Drizzle schema 中生成 auth 表
- **Type-safe relations**: Drizzle relations 为 joins 提供完整类型安全

---

## 注意事项

- Auth 表存在于 schema 中但是自动生成的 - 不要编辑
- 使用 `bun run db:studio` 进行可视化数据库检查
- Schema 更改应该提交，生成的 migrations 被跟踪

---
